___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Hookflash - AWIN Last Click Identifier",
  "brand": {
    "id": "brand_dummy",
    "displayName": "Hookflash",
    "thumbnail": "data:image/jpeg;base64,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"
  },
  "description": "Fixes 2 issues with the AWIN LCI\n\n- Stops source value check after match to stop overwriting cookie incorrectly\n\n- Checks for exact match instead of contains to stop confusion with some gclids",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "cookieName",
    "displayName": "Cookie name",
    "simpleValueType": true,
    "valueHint": "e.g AwinChannelCookie",
    "defaultValue": "AwinChannelCookie",
    "valueValidators": [
      {
        "type": "REGEX",
        "args": [
          "^[a-zA-Z0-9_-]*$"
        ]
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "cookiePeriod",
    "displayName": "Cookie length",
    "simpleValueType": true,
    "defaultValue": 30
  },
  {
    "type": "TEXT",
    "name": "sourceParameters",
    "displayName": "Used Source Parameters",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "awinSource",
    "displayName": "Awin Source Values",
    "simpleValueType": true
  },
  {
    "type": "CHECKBOX",
    "name": "organicFIlter",
    "checkboxText": "Organic Filter",
    "simpleValueType": true
  },
  {
    "type": "CHECKBOX",
    "name": "overwriteCookieDomain",
    "checkboxText": "Overwrite Cookie Domain",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "awinChannelCookieDomain",
    "displayName": "AwinChannelCookie Domain",
    "simpleValueType": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

//Permissions
const queryPermission = require('queryPermission');
const setCookie = require('setCookie');
const getCookie = require('getCookieValues');
const log = require('logToConsole');
const referrerURL = require('getReferrerUrl');
let queryParameters = require('getUrl');
const assertThat = require('assertThat');

//Variables from input fields
const cookiePeriod = data.cookiePeriod;
const cookieName = data.cookieName;
const sourceParameters = data.sourceParameters.split(","); // e.g., ["source", "utm_source", "utm_medium", "gclid"]
const organicFilter = data.organicFilter;
const awinSource = data.awinSource.split(","); // e.g., ["aw", "awin", "aff"]
const parseUrl = require('parseUrl');
const overwriteCookieDomain = data.overwriteCookieDomain;
const awinChannelCookieDomain = data.awinChannelCookieDomain;

//URL variables.
let referrer = referrerURL(); // This returns the referrer URL for deduping against organic.
let URL = queryParameters();  // This returns the current URL.
let urlObject = parseUrl(URL); // The parsed URL object for e.g. urlObject.origin, urlObject.host, etc.
let origin = urlObject.origin; // Returns the origin.
let cookieDomain = "";         // We'll build the cookie domain from the host (or use user-defined).
let urlParts = urlObject.host.split("."); // e.g. ["www", "example", "com"]

//Internal script variables
let sourceValue = "";
let awLastClick = "";
let matchedSourceParameter = "na";
let containsAwaid = false;
let cookieLength;
let isOrganicJourney = false;

// Convert the entire query string into an array of "param=value"
queryParameters = queryParameters('query', false, null, 'query').split("&");

// Custom "Contains" function: checks if `substring` is found in `string` char-by-char.
const Contains = function (string, substring) {
  let contains = false;
  const stringCharacters = string.split("");
  const substringCharacters = substring.split("");
  let substringMatchedCharacters = substringCharacters.length;
  let j = 0;

  for (var i = 0; i < stringCharacters.length; i++) {
    if (substringCharacters[j] === undefined) {
      j = 0;
    }
    if (stringCharacters[i] === substringCharacters[j]) {
      substringMatchedCharacters--;
      j++;
      if (substringMatchedCharacters === 0) {
        contains = true;
        break;
      }
    } else {
      substringMatchedCharacters = substringCharacters.length;
      j = 0;
    }
  }

  if (substringMatchedCharacters > 0) {
    contains = false;
  }

  return contains;
};

// Decide cookie domain
if (overwriteCookieDomain) {
  cookieDomain = awinChannelCookieDomain;
} else {
  for (var i = 0; i < urlParts.length; i++) {
    if (urlParts[i] !== "www") {
      cookieDomain += "." + urlParts[i];
    }
  }
}

let websiteDomain = "";
if (cookieDomain.substring(0, 1) === ".") {
  websiteDomain = cookieDomain.substring(1);
} else {
  websiteDomain = cookieDomain;
}

cookieLength = 60 * 60 * 24 * cookiePeriod;

const sessionOptions = {
  domain: cookieDomain,
  path: '/',
  secure: false
};

const defaultOptions = {
  domain: cookieDomain,
  path: '/',
  'max-age': cookieLength,
  secure: false
};

// A helper to set the AwinChannel cookie with either session or default options
function SetChannelCookie() {
  // If cookiePeriod=0, we want a session cookie.
  // If matchedSourceParameter="na" and not organic, and there's no existing cookie, we set "direct".
  if (cookiePeriod === 0 && matchedSourceParameter === "na" && !isOrganicJourney && !getCookie(cookieName)[0]) {
    awLastClick = "direct";
    setCookie(cookieName, awLastClick, sessionOptions, false);
    data.gtmOnSuccess();
    return;
  } else if (cookiePeriod === 0) {
    setCookie(cookieName, awLastClick, sessionOptions, false);
    return;
  }
  setCookie(cookieName, awLastClick, defaultOptions, false);
}

// 1) If the user is navigating within the same domain, we do nothing (just end).
//    Because we only want to run "last-click detection" on the first page of a session.
if (Contains(referrer, websiteDomain)) {
  data.gtmOnSuccess();
} else {
  // 2) This is a new session (from an external referrer). We'll figure out if it's AW, other, or direct.

  // --- Check if 'awaid' param is in the URL. If yes => AW, done. ---
  for (var i = 0; i < queryParameters.length; i++) {
    let paramPair = queryParameters[i].split("=");
    let paramName = paramPair[0];
    let paramValue = paramPair[1] ? paramPair[1] : "";

    if (paramName === "awaid") {
      containsAwaid = true;
      awLastClick = "aw";
      SetChannelCookie();
      data.gtmOnSuccess();
      return; // We stop right away if we see "awaid".
    }
  }

  // --- Otherwise, gather all the source param values to see if ANY is "aw" or "awin"... ---
  let foundAnySourceParam = false;
  let foundAwin = false;

  // Loop over each query param again, looking specifically for the names in sourceParameters
  for (var j = 0; j < queryParameters.length; j++) {
    let paramPair = queryParameters[j].split("=");
    let paramName = paramPair[0];
    let paramValue = paramPair[1] ? paramPair[1].toLowerCase() : "";

    // If this param name is in the sourceParameters array, then we have a "paid channel" param
    if (sourceParameters.indexOf(paramName) > -1) {
      foundAnySourceParam = true;

      // === IMPORTANT CHANGE: Skip checking Google, Bing, and FB for Awin substring ===
      if (paramName !== "gclid" && paramName !== "fbclid" &&
      paramName !== "msclkid") {
        // Check if paramValue CONTAINS any of the strings in awinSource
        for (var a = 0; a < awinSource.length; a++) {
          let awString = awinSource[a].toLowerCase();
          if (Contains(paramValue, awString)) {
            foundAwin = true;
            break;
          }
        }
      }
    }
  }

  // Summarize the result:
  //  - If we found "aw" in paramValue => matchedSourceParameter="aw"
  //  - Else if we found some source param but no AW => "other"
  //  - Else we found no source param => "na"
  if (foundAwin) {
    matchedSourceParameter = "aw";
  } else if (foundAnySourceParam) {
    matchedSourceParameter = "other";
  } else {
    matchedSourceParameter = "na";
  }

  // 3) Now apply the organic filter logic or normal logic
  if (organicFilter === true) {
    // With organicFilter = true, if matchedSourceParameter=aw => "aw"
    // If the referrer is search engine => "organic"
    // Otherwise => "other"
    if (matchedSourceParameter === "aw") {
      awLastClick = "aw";
      SetChannelCookie();
    } else if (
      Contains(referrer, "google") ||
      Contains(referrer, "bing") ||
      Contains(referrer, "yahoo") ||
      Contains(referrer, "yandex") ||
      Contains(referrer, "duckduckgo")
    ) {
      awLastClick = "organic";
      isOrganicJourney = true;
      SetChannelCookie();
    } else if (matchedSourceParameter === "other") {
      awLastClick = "other";
      SetChannelCookie();
    }
  } else {
    // organicFilter = false => we only do "aw" or "other"
    if (matchedSourceParameter === "aw") {
      awLastClick = "aw";
      SetChannelCookie();
    } else if (matchedSourceParameter === "other") {
      awLastClick = "other";
      SetChannelCookie();
    }
  }

  // 4) If no cookie was set so far, default to "direct"
  if (!getCookie(cookieName)[0]) {
    awLastClick = "direct";
    SetChannelCookie();
  }

  // Done
  data.gtmOnSuccess();
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_referrer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 3/28/2025, 11:24:45 AM


